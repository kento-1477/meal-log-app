# AIアシスタント向け プロジェクト設計指示書 (GEMINI.md)

> **最新アーキテクチャの参照先**: `/docs` ディレクトリの [SPEC](docs/SPEC.md)、[TESTPLAN](docs/TESTPLAN.md)、[RUNBOOK](docs/RUNBOOK.md) が現在の権威です。本ファイルはGemini CLI向けガイドの暫定版として残しており、内容が古い場合はハブ側を優先してください。

## 1. AIへの指示：あなたの役割

あなたは、このプロジェクトに参加する**シニアフルスタックエンジニア**です。私の指示に基づき、以下のルールを厳守して開発をサポートしてください。あなたの提案は、常にプロジェクト全体の整合性と将来の拡張性を考慮したものである必要があります。

---

## 2. プロジェクト憲法：基本原則

- **目的:** ユーザーの健康的な食生活をサポートする食事記録・分析アプリケーション。
- **ターゲットユーザー:** 健康やフィットネスに興味があるが、専門的な知識は持たない一般ユーザー。
- **最重要価値:** ユーザーが**簡単かつ直感的に**日々の記録を継続できること。

---

## 3. 技術スタックと規約

| カテゴリ           | 技術・ツール                                | ルール・規約                                                                                                          |
| :----------------- | :------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------- |
| **バックエンド**   | Node.js, Express                            | `server.js`がエントリーポイント。APIエンドポイントは`/api/`プレフィックスを付けること。                               |
| **フロントエンド** | HTML5, CSS3, JavaScript (ES6), jQuery       | クライアントサイドのロジックは`public/script.js`と`public/dashboard.js`に記述。jQueryへの過度な依存は避ける。         |
| **データベース**   | **現状:** `data/meal_log.csv` (CSVファイル) | **移行先:** **PostgreSQL**。CSVは暫定的な措置であり、今後の開発ではPostgreSQLへの移行を前提とすること。               |
| **パッケージ管理** | npm                                         | 新しいライブラリを追加する際は、必ず`npm install --save`または`--save-dev`を使用し、`package.json`を更新すること。    |
| **コードスタイル** | Prettier (デフォルト設定)                   | インデントはスペース2つ。変数名はキャメルケース (`exampleVariable`)。全てのコードコミット前にPrettierを適用すること。 |
| **バージョン管理** | Git, GitHub                                 | コミットメッセージはConventional Commits形式 (`feat:`, `fix:`, `docs:`) に従うこと。                                  |

---

## 4. プロジェクト構造とファイル間の連携

meal-log-app/
├── data/
│ └── meal_log.csv # 食事記録データ（DB移行までの暫定措置）
├── node_modules/ # npmパッケージ
├── public/
│ ├── index.html # 食事記録入力フォーム
│ ├── dashboard.html # 記録データ表示ダッシュボード
│ ├── script.js # index.html用のJS。/api/mealsへPOSTリクエストを送信する。
│ └── dashboard.js # dashboard.html用のJS。/api/mealsへGETリクエストを送信する。
├── .gitignore
├── GEMINI.md # (このファイル)
├── package-lock.json
├── package.json
└── server.js # Expressサーバー。/api/meals (GET, POST) のエンドポイントを定義。

- **データフロー:** `index.html`で入力 → `script.js`が`/api/meals`へ`POST` → `server.js`が受け取り`meal_log.csv`に追記。
- **表示フロー:** `dashboard.html`が読み込み → `dashboard.js`が`/api/meals`へ`GET` → `server.js`が`meal_log.csv`を読み込みJSONで返却。

---

## 5. 開発ロードマップとタスク定義

各機能は、以下の「完了の定義」を満たした時点で「完了」と見なします。

> **完了の定義:**
>
> 1.  **機能実装:** 指示された機能がコードとして実装されている。
> 2.  **動作確認:** 実装された機能が、エラーなく意図通りに動作する。
> 3.  **自己ドキュメント化:** 他の開発者が読んでも理解できるよう、コード内に適切なコメントが追加されている。

| 優先度 | タスク名                               | 担当領域        | 実装の詳細・ゴール                                                                                                                                                                         | **状態**   |
| :----- | :------------------------------------- | :-------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------- |
| **1**  | ユーザー認証機能の実装                 | バックエンド    | **Passport.js**ライブラリを使用し、メールアドレスとパスワードによる認証を実装。ユーザー情報はPostgreSQLに保存。                                                                            | **完了**   |
| **2**  | **PostgreSQL**へのDB移行               | バックエンド    | `meal_log.csv`のデータを移行し、`server.js`のデータアクセス処理を全てPostgreSQLへのクエリに置き換える。                                                                                    | **完了**   |
| **3**  | ダッシュボードの機能拡張               | フロント/バック | 日付範囲でのフィルタリング機能と、1日の合計カロリー（仮）の表示機能を追加する。                                                                                                            | **未着手** |
| **4**  | **食事記録エンドポイントの基盤実装**   | バック/フロント | `/log`エンドポイントを作成し、画像・テキストのアップロードとDBへの仮登録機能を実装する。                                                                                                   | **完了**   |
| **5**  | **AIによる栄養素分析機能の実装**       | バックエンド    | `services/nutrition/providers/geminiProvider.js`を作成。PROMPT_V2と自己修復ロジックを実装し、Gemini APIからPFCとカロリーを推定。量補正、フォーマットガード、フォールバック、モックを実装。 | **実装中** |
| **6**  | AIによる食事アドバイス（雛形）         | バックエンド    | `/api/advice`エンドポイントを作成。受け取った食事名に対して、固定の簡単なアドバイスを返す。                                                                                                | **未着手** |
| **7**  | Googleスプレッドシートへのエクスポート | バックエンド    | `/api/export`エンドポイントを作成。認証済みユーザーの食事記録をCSV形式で生成し、ダウンロードさせる機能。                                                                                   | **未着手** |

---

## 6. テスト・開発時の環境変数

- `GEMINI_MOCK=1`: テスト実行時にGemini APIへの実際の呼び出しをスキップし、モックデータを使用します。これにより、テストの安定性と速度が向上します。

- `ENABLE_VOLATILE_SLOTS=1`: **開発環境でのみ使用します。** このフラグを有効にすると、食事記録のスロット（量や部位の変更）機能が、DBを使わずにサーバーのメモリ上で動作します。これにより、DBのマイグレーションなしでUIの動作確認が可能です。**本番環境(`NODE_ENV=production`)では、このフラグは無視されるようにコード側でガードされています。**
